<!--
Copyright 2012 Hans Beemsterboer

This file is part of the TechyTax program.

TechyTax is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 3 of the License, or
(at your option) any later version.

TechyTax is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with TechyTax; if not, write to the Free Software
Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
-->
<!DOCTYPE sqlMap 
          PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
          "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="Fiscaal">
	<typeAlias alias="activum" type="org.techytax.domain.Activum" />
	<typeAlias alias="passiva" type="org.techytax.domain.Passivum" />	
	<typeAlias alias="aftrekpost" type="org.techytax.domain.Aftrekpost" />
	<typeAlias alias="keyYear" type="org.techytax.domain.KeyYear" />
	<parameterMap id="periodeMap" class="java.util.Map">
		<parameter property="beginDatum" javaType="string" />
		<parameter property="eindDatum" javaType="string" />
		<parameter property="userId" javaType="string" />
	</parameterMap>
	<select id="getDeductableCostList" parameterMap="periodeMap"
		resultClass="aftrekpost">
		select k.bedrag as aftrekbaarBedrag, ks.id as kostenSoortId 
		from
		kosten as k, kostensoort as ks 
		where 
		k.kostensoort_id = ks.id
		and	kostensoort_id in  (select id 
								from kostensoort 
								where
								aftrekbaar=1)
		and datum &gt;= ? 
		and	datum &lt;= ?
		and user_id = ? 
	</select>
	<select id="getActivaLijst" parameterClass="keyYear"
		resultClass="activum">
		select balanssoort.omschrijving, kosten.bedrag, kosten.btw, boekwaarde.boekjaar, boekwaarde.saldo, restwaarde.restwaarde 
		from balans, activa, kosten, balanssoort, boekwaarde, restwaarde 
		where
		balans.balanssoort_id = balanssoort.id and 
		kosten.id = activa.kost_id and
		activa.balans_id = balans.id and 
		boekwaarde.balans_id = balans.id and 
		restwaarde.activa_id = activa.id and 
		(boekjaar=#year#-1) and
		activa.einddatum is null
		and activa.user_id = #userId#
	    and boekwaarde.user_id = #userId#
	    and restwaarde.user_id = #userId# 
		
		group by balans.balanssoort_id
		
		union
		
		select balanssoort.omschrijving, kosten.bedrag, kosten.btw, boekwaarde.boekjaar, boekwaarde.saldo, restwaarde.restwaarde 
		from balans, activa, kosten, balanssoort, boekwaarde, restwaarde 
		where balans.balanssoort_id =
		balanssoort.id and 
		kosten.id = activa.kost_id and
		activa.balans_id = balans.id and 
		boekwaarde.balans_id = balans.id and 
		restwaarde.activa_id = activa.id and
		(boekjaar=#year#) and 
		activa.einddatum is null
		and activa.user_id = #userId#
	    and boekwaarde.user_id = #userId#
	    and restwaarde.user_id = #userId#  
		
		group by balans.balanssoort_id 
		
		union 
		 
		select balanssoort.omschrijving, NULL, NULL, boekwaarde.boekjaar,	boekwaarde.saldo, NULL 
		from balans, balanssoort, boekwaarde 
		where
		boekwaarde.balans_id = balans.id and 
		(boekjaar=#year# or boekjaar=#year#-1) and 
		balanssoort.id in (3,6) and
		balans.balanssoort_id = balanssoort.id and 
		boekwaarde.user_id = #userId#
		
		order by omschrijving, boekjaar;
	</select>
	<select id="getPassivaLijst" parameterClass="keyYear"
		resultClass="passiva">
		select balanssoort.omschrijving, boekwaarde.boekjaar, boekwaarde.saldo 
		from balans, balanssoort, boekwaarde 
		where
		boekwaarde.balans_id = balans.id and 
		(boekjaar=#year# or boekjaar=#year#-1) and 
		balans.balanssoort_id = balanssoort.id
		and balanssoort.id in (4,5)
		and boekwaarde.user_id = #userId#
		order by omschrijving, boekjaar;
	</select>
	<insert id="insertActivum" parameterClass="activum">
		insert into activa
		values(#id#,#userId#,#balanceType#,#costId#,null)
		<selectKey resultClass="int" keyProperty="id">
			SELECT @@IDENTITY AS ID
		</selectKey>		
	</insert>
	<update id="updateActivum" parameterClass="activum">
		update activa set einddatum = #endDate#
		where kost_id = #costId#
		and user_id = #userId#
	</update>
	<select id="getActivumByCostId" parameterClass="activum" resultClass="activum">
		SELECT activa.id, activa.user_id as userId, activa.balans_id as balanceType, activa.kost_id as costId, restwaarde.restwaarde, activa.einddatum as endDate
		FROM activa, restwaarde
		WHERE activa.user_id=#userId#
		AND activa.id = restwaarde.activa_id
		AND activa.kost_id=#costId# 
	</select>				
</sqlMap>